<tool id="beams" name="BEAMS" version="0.1.0">
    <description> - Birmingham mEtabolite Annotation for Mass SpectroMetry</description>
    <requirements>
        <requirement type="package" version="0.1.0">beams</requirement>
    </requirements>
    <code file="get_databases.py" />
    <command detect_errors="exit_code"><![CDATA[
        echo ""
        #if $group_features.condi.flag == "true"
            &&
            python -m beams group-features
                --peaklist "$peaklist"
                --intensity-matrix "$group_features.condi.intensity_matrix" 
                --gml-file "$output_graph" 
                --db "$output_sqlite" 
                --max-rt-diff $group_features.condi.max_rt_diff
                --method $group_features.condi.grouping_method
                --coeff-threshold $group_features.condi.coefficient_threshold
                --pvalue-threshold $group_features.condi.pvalue_threshold
                --ncpus \${GALAXY_SLOTS:-4}
        #end if

        #if $annotate_peak_patterns.condi.flag == "true" 
            &&
            python -m beams annotate-peak-patterns
                --peaklist "$peaklist"
                #if $intensity_matrix
                    --intensity-matrix "$intensity_matrix" 
                #end if
                #if $group_features.condi.flag == "true"
                    --gml-file "$output_graph"
                #end if
                --db "$output_sqlite"
                --ion-mode $ion_mode
                --ppm $annotate_peak_patterns.condi.ppm
                #if $annotate_peak_patterns.condi.adducts_condi.flag == "true"
                    --adducts
                    #if $annotate_peak_patterns.condi.adducts_condi.library
                        --adducts-library "$annotate_peak_patterns.condi.adducts_condi.library"
                    #end if
                #end if
                #if $annotate_peak_patterns.condi.isotopes_condi.flag == "true"
                    --isotopes
                    #if $annotate_peak_patterns.condi.isotopes_condi.library
                        --isotopes-library "$annotate_peak_patterns.condi.isotopes_condi.library"
                    #end if
                #end if
                #if $annotate_peak_patterns.condi.multiple_charged_ions_condi.flag == "true"
                    --multiple-charged-ions
                    #if $annotate_peak_patterns.condi.multiple_charged_ions_condi.library
                        --multiple-charged-ions-library "$annotate_peak_patterns.condi.multiple_charged_ions_condi.library"
                    #end if
                #end if
                #if $annotate_peak_patterns.condi.oligomers_condi.flag == "true"
                    --oligomers
                    --max_monomer_units $max_monomer_units
                #end if
        #end if

        #if $annotate_molecular_formulae.condi.flag == "true"
            &&
            python -m beams annotate-mf
                --peaklist "$peaklist" 
                #if $intensity_matrix
                    --intensity-matrix "$intensity_matrix" 
                #end if
                --db "$output_sqlite"
                #if $annotate_molecular_formulae.condi.condi.source == "url"
                    --db-mf "http://multiomics-int.cs.bham.ac.uk"
                    $annotate_molecular_formulae.condi.condi.heuristic_rules
                    --max-mz $annotate_molecular_formulae.condi.condi.max_mz
                #end if
                #if $annotate_molecular_formulae.condi.condi.source == "file"
                    --db-mf "$annotate_molecular_formulae.condi.condi.reference_file"
                #end if
                --ion-mode $ion_mode
                --ppm $annotate_molecular_formulae.condi.ppm
                #if $adducts_library
                    --adducts-library "$adducts_library"
                #end if
        #end if

        #if $annotate_compounds.condi.flag == "true"
            &&
            python -m beams annotate-compounds
                --peaklist "$peaklist" 
                #if $intensity_matrix
                    --intensity-matrix "$intensity_matrix" 
                #end if
                --db "$output_sqlite"
                #if $annotate_compounds.condi.condi.source == "databases"
                    --db-name "$annotate_compounds.condi.condi.db_name"
                #end if
                #if $annotate_compounds.condi.condi.source == "file"
                    --db-compounds "$annotate_compounds.condi.condi.reference_file"
                    --db-name "reference_file"
                #end if
                --ion-mode $ion_mode
                --ppm $annotate_compounds.condi.ppm
                #if $adducts_library
                    --adducts-library $adducts_library
                #end if

        #end if
        #for $format in $summary.format
            &&
            python -m beams summary-results
                --peaklist "$peaklist"
                #if $intensity_matrix
                    --intensity-matrix "$intensity_matrix" 
                #end if
                --db "$output_sqlite"

                #if $format.rc == ""
                    --output "summary_mr_mc.tsv"
                #else if $format.rc == "--single-row"
                    --output "summary_sr_mc.tsv"
                #else if $format.rc == "--single-row --single-column"
                    --output "summary_sr_sc.tsv"
                #end if

                --pdf "$output_charts"
                --sep tab
                $format.rc
                #if $format.convert_rt != "skip"
                    --convert-rt $format.convert_rt
                #end if
        #end for
    ]]></command>
    <inputs>
        <param name="peaklist" type="data" format="tsv" label="Peaklist" help="" />
        <param name="intensity_matrix" type="data" optional="true" format="tsv" label="Intensity matrix" help="" />
        <param name="ion_mode" type="select" label="Ion mode">
            <option value="pos" selected="True">Positive</option>
            <option value="neg" selected="True">Negative</option>
        </param>
        <param name="adducts_library" type="data" optional="true" format="tsv" label="Adduct library" help="" />
        <section name="group_features" title="Group Features" help="" expanded="True">
            <conditional name="condi">
                <param name="flag" type="boolean" checked="true" label=" " help="" truevalue="true" falsevalue="false" />
                <when value="true">
                    <param name="intensity_matrix" type="data" format="tsv" label="Intensity matrix" help=""/>
                    <param name="max_rt_diff" value="5.0" type="float" label="Maximum retention time difference (sec)" help="">
                    </param>
                    <param name="grouping_method" type="select" label="Grouping method">
                        <option value="pearson" selected="True">Pearson correlation</option>
                        <option value="spearman">Spearman rank correlation</option>
                    </param>
                    <param name="coefficient_threshold" value="0.7" type="text" label="Coefficient threshold" help="">
                    </param>
                    <param name="pvalue_threshold" value="0.0001" type="text" label="P-value threshold" help="">
                    </param>
                </when>
                <when value="false" />
            </conditional>
        </section>
        <section name="annotate_peak_patterns" title="Annotate Peak Patterns" expanded="True">
            <conditional name="condi">
                <param name="flag" type="boolean" checked="true" label=" " help="" truevalue="true" falsevalue="false" />
                <when value="true">
                    <param name="ppm" type="float" value="5.0" label="Ppm error tolerance" help="Maximum tolerated m/z deviation in parts per million (ppm)." />
                    <conditional name="adducts_condi">
                        <param name="flag" type="boolean" checked="true" label="Annotate adducts" help="" truevalue="true" falsevalue="false" />
                        <when value="true">
                           <param name="library" type="data" optional="true" format="tsv" label="Library" help="" />
                        </when>
                        <when value="false" />
                    </conditional>
                    <conditional name="isotopes_condi">
                        <param name="flag" type="boolean" checked="true" label="Annotate isotopes" help="" truevalue="true" falsevalue="false" />
                        <when value="true">
                           <param name="library" type="data" optional="true" format="tsv" label="Library" help="" />
                        </when>
                        <when value="false" />
                    </conditional>
                    <conditional name="multiple_charged_ions_condi">
                        <param name="flag" type="boolean" checked="false" label="Annotate multiple charged ions" help="" truevalue="true" falsevalue="false" />
                        <when value="true">
                           <param name="library" type="data" optional="true" format="tsv" label="Library" help="" />
                        </when>
                        <when value="false" />
                    </conditional>
                    <conditional name="oligomers_condi">
                        <param name="flag" type="boolean" checked="false" label="Annotate oligomers" help="" truevalue="true" falsevalue="false" />
                        <when value="true">
                           <param name="max_monomer_units" value="2" type="integer" label="Maximum number of 'monomer' units" help="" />
                        </when>
                        <when value="false" />
                    </conditional>
                </when>
                <when value="false" />
            </conditional>
        </section>
        <section name="annotate_molecular_formulae" title="Annotate Molecular Formulae" expanded="True">
            <conditional name="condi">
                <param name="flag" type="boolean" checked="false" label=" " help="" truevalue="true" falsevalue="false" />
                <when value="true">
                    <param name="ppm" type="float" value="5.0" label="Ppm error tolerance" help="Maximum tolerated m/z deviation in parts per million (ppm)." />
                    <conditional name="condi">
                        <param name="source" type="select" label="Source">
                            <option value="url" selected="True">http://multiomics-int.cs.bham.ac.uk</option>
                            <option value="file">Tab-delimited text file</option>
                        </param>
                        <when value="url">
                            <param name="max_mz" value="500" type="integer" label="Maximum m/z" help="" />
                            <param name="heuristic_rules" type="boolean" checked="true" label="Heuristic rules" help="" truevalue="--heuristic-rules" falsevalue="" />
                        </when>
                        <when value="file">
                            <param name="reference_file" type="data" format="tsv" label="Library" help="" />
                        </when>
                    </conditional>
                </when>
                <when value="false" />
            </conditional>
        </section>
        <section name="annotate_compounds" title="Annotate Compounds / Metabolites" expanded="True">
            <conditional name="condi">
                <param name="flag" type="boolean" checked="false" label=" " help="" truevalue="true" falsevalue="false" />
                <when value="true">
                    <param name="ppm" type="float" value="5.0" label="Ppm error tolerance" help="Maximum tolerated m/z deviation in parts per million (ppm)." />
                    <conditional name="condi">
                        <param name="source" type="select" label="Source" refresh_on_change="true">
                            <option value="databases" selected="True">Compound databases</option>
                            <option value="file">Tab-delimited text file</option>
                        </param>
                        <when value="databases">
                           <param name="db_name" type="select" label="Select databases" multiple="true" display="checkboxes" dynamic_options = "get_databases()" >
                               <validator type="no_options" message="Select at least one database." />      
                           </param>
                        </when>
                        <when value="file">
                            <param name="reference_file" type="data" format="tsv" label="Library" help="" />
                        </when>
                    </conditional>
                </when>
                <when value="false" />
            </conditional>
        </section>
        <section name="summary" title="Create summary table" help="" expanded="True">
            <repeat name="format" title="Add table format" min="1">
                <param name="rc" type="select" label=" ">
                    <option value="" selected="True">Multiple rows for each feature and separate columns</option>
                    <option value="--single-row">Single row for each feature and separate columns</option>
                    <option value="--single-row --single-column">Single row for each feature and merged columns</option>
                </param>
                <param name="convert_rt" type="select" label="Convert RT">
                    <option value="skip" selected="True">skip</option>
                    <option value="min">to minutes</option>
                    <option value="sec">to seconds</option>
                </param>
            </repeat>

        </section>
    </inputs>
    <outputs>
        <data name="output_graph" format="txt" label="${tool.name} on ${on_string}: Correlation network (Graph Modelling Language)" >
            <filter>group_features["condi"]["flag"] is True</filter>
        </data>
        <data name="output_sqlite" format="sqlite" label="${tool.name} on ${on_string}: SQLite database" />

        <data name="output_summary_mr_mc" format="tsv" label="${tool.name} on ${on_string}: Summary table (Multiple rows and separate columns)" from_work_dir="summary_mr_mc.tsv" />
        <data name="output_summary_sr_mc" format="tsv" label="${tool.name} on ${on_string}: Summary table (Single row and separate columns)" from_work_dir="summary_sr_mc.tsv" />
        <data name="output_summary_sr_sc" format="tsv" label="${tool.name} on ${on_string}: Summary table (Single row and merged columns)" from_work_dir="summary_sr_sc.tsv" />

        <data name="output_charts" format="pdf" label="${tool.name} on ${on_string}: Summary charts" />
    </outputs>
    <tests>
        <test>
            <param name="peaklist" value="variableMetadata.txt"/>
            <param name="intensity_matrix" value="dataMatrix.txt"/>

            <param name="group_features|condi|flag" value="true"/>
            <param name="group_features|condi|intensity_matrix" value="dataMatrix.txt"/>

            <param name="annotate_peak_patterns|condi|flag" value="true"/>

            <param name="annotate_peak_patterns|condi|annotate_adducts_condi|flag" value="true"/>
            <param name="annotate_peak_patterns|condi|annotate_adducts_condi|adducts_library" value="adducts.txt"/>
            <param name="annotate_peak_patterns|condi|annotate_isotopes_condi|flag" value="true"/>
            <param name="annotate_peak_patterns|condi|annotate_isotopes_condi|isotopes_library" value="isotopes.txt"/>

            <param name="annotate_molecular_formulae|condi|flag" value="false"/>
            <param name="annotate_compounds|condi|flag" value="false"/>

            <repeat name="summary|format">
                <param name="rc" value=""/>
                <param name="rt_convert" value="skip"/>
            </repeat>

            <repeat name="summary|format">
                <param name="rc" value="--single-row"/>
                <param name="rt_convert" value="skip"/>
            </repeat>

            <repeat name="summary|format">
                <param name="rc" value="--single-row --single-column"/>
                <param name="rt_convert" value="skip"/>
            </repeat>

            <output name="output_graph" file="output_graph_pp.gml" ftype="txt" compare="sim_size"/>
            <output name="output_sqlite" file="output_db_pp.sqlite" ftype="sqlite" compare="sim_size"/>
            <output name="output_summary_mr_mc" file="summary_mr_mc_pp.tsv" ftype="tsv" />
            <output name="output_summary_sr_mc" file="summary_sr_mc_pp.tsv" ftype="tsv" />
            <output name="output_summary_sr_sc" file="summary_sr_sc_pp.tsv" ftype="tsv" />
            <output name="output_charts" file="charts_pp.pdf" ftype="pdf" compare="sim_size"/>
        </test>
        <test>
            <param name="peaklist" value="variableMetadata_intensity.txt"/>
            <param name="adducts_library" value="adducts.txt"/>

            <param name="group_features|condi|flag" value="false"/>
            <param name="annotate_peak_patterns|condi|flag" value="false"/>
            <param name="annotate_molecular_formulae|condi|flag" value="false"/>
            <param name="annotate_compounds|condi|flag" value="true"/>

            <param name="annotate_compounds|condi|condi|source" value="databases"/>
            <param name="annotate_compounds|condi|condi|db_name" value="hmdb_full_v4_0_v1"/>
            <param name="annotate_compounds|condi|ppm" value="3.0"/>
            
            <repeat name="summary|format">
                <param name="rc" value=""/>
                <param name="rt_convert" value="skip"/>
            </repeat>
            <repeat name="summary|format">
                <param name="rc" value="--single-row"/>
                <param name="rt_convert" value="skip"/>
            </repeat>
            <repeat name="summary|format">
                <param name="rc" value="--single-row --single-column"/>
                <param name="rt_convert" value="skip"/>
            </repeat>

            <output name="output_sqlite" file="output_db_ac.sqlite" ftype="sqlite" compare="sim_size"/>
            <output name="output_summary_mr_mc" file="summary_mr_mc_ac.tsv" ftype="tsv" />
            <output name="output_summary_sr_mc" file="summary_sr_mc_ac.tsv" ftype="tsv" />
            <output name="output_summary_sr_sc" file="summary_sr_sc_ac.tsv" ftype="tsv" />
            <output name="output_charts" file="charts_ac.pdf" ftype="pdf" compare="sim_size"/>
        </test>
        <test>
            <param name="peaklist" value="variableMetadata.txt"/>
            <param name="intensity_matrix" value="dataMatrix.txt"/>
            <param name="adducts_library" value="adducts.txt"/>

            <param name="group_features|condi|flag" value="true"/>
            <param name="group_features|condi|intensity_matrix" value="dataMatrix.txt"/>

            <param name="annotate_peak_patterns|condi|flag" value="true"/>

            <param name="annotate_peak_patterns|condi|annotate_adducts_condi|flag" value="true"/>
            <param name="annotate_peak_patterns|condi|annotate_adducts_condi|adducts_library" value="adducts.txt"/>
            <param name="annotate_peak_patterns|condi|annotate_isotopes_condi|flag" value="true"/>
            <param name="annotate_peak_patterns|condi|annotate_isotopes_condi|isotopes_library" value="isotopes.txt"/>

            <param name="annotate_molecular_formulae|condi|flag" value="false"/>
            <param name="annotate_compounds|condi|flag" value="true"/>

            <param name="annotate_compounds|condi|condi|source" value="databases"/>
            <param name="annotate_compounds|condi|condi|db_name" value="hmdb_full_v4_0_v1"/>
            <param name="annotate_compounds|condi|ppm" value="3.0"/>

            <repeat name="summary|format">
                <param name="rc" value=""/>
                <param name="rt_convert" value="skip"/>
            </repeat>

            <repeat name="summary|format">
                <param name="rc" value="--single-row"/>
                <param name="rt_convert" value="skip"/>
            </repeat>

           <repeat name="summary|format">
                <param name="rc" value="--single-row --single-column"/>
                <param name="rt_convert" value="skip"/>
            </repeat>

            <output name="output_graph" file="output_graph_pp_ac.gml" ftype="txt" compare="sim_size"/>
            <output name="output_sqlite" file="output_db_pp_ac.sqlite" ftype="sqlite" compare="sim_size"/>
            <output name="output_summary_mr_mc" file="summary_mr_mc_pp_ac.tsv" ftype="tsv" />
            <output name="output_summary_sr_mc" file="summary_sr_mc_pp_ac.tsv" ftype="tsv" />
            <output name="output_summary_sr_sc" file="summary_sr_sc_pp_ac.tsv" ftype="tsv" />
            <output name="output_charts" file="charts_pp_ac.pdf" ftype="pdf" compare="sim_size"/>
        </test>
    </tests>
    <help>
    </help>
    <citations>
    </citations>
</tool>
