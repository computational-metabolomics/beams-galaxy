<tool id="beams_annotation" name="Beams - Birmingham mEtabolite Annotation for Mass SpectroMetry" version="0.1.0">
    <description></description>
    <macros>
        <import>macros.xml</import>
    </macros>
    <expand macro="requirements" />
    <command><![CDATA[
        #if $advancedOptions.groupFeaturesCheck.groupFeatures == 'true' 
            python -m beams group-features
                --peaklist '$peakList' 
                --intensity-matrix '$intensityMatrix' 
                --gml '$output_graph' 
                --db '$result_sqlite' 
                --max-rt-diff '$advancedOptions.groupFeaturesCheck.maxRTDifference' 
                --method '$advancedOptions.groupFeaturesCheck.groupingMethod' 
                --coeff-threshold '$advancedOptions.groupFeaturesCheck.coefficientThreshold' 
                --pvalue-threshold '$advancedOptions.groupFeaturesCheck.pValueThreshold';
        #end if

        #if $advancedOptions.peakPatternsAnnotationCheck.annotatePeakPatterns == 'true' 
            python -m beams annotate-peak-patterns
                --peaklist '$peakList' 
                --intensity-matrix '$intensityMatrix' 
                --gml '$output_graph' 
                --db '$result_sqlite'
                #if $advancedOptions.peakPatternsAnnotationCheck.adductsCheck.useAdductsLibrary == 'true'
                    --adducts 
                    --adducts-library '$advancedOptions.peakPatternsAnnotationCheck.adductsCheck.adductsLibrary'
                #end if
                #if $advancedOptions.peakPatternsAnnotationCheck.isotopesCheck.useIsotopesLibrary == 'true'
                    --isotopes 
                    --isotopes-library '$advancedOptions.peakPatternsAnnotationCheck.isotopesCheck.isotopesLibrary'
                #end if
                #if $advancedOptions.peakPatternsAnnotationCheck.multipleChargedIonsCheck.useMultipleChargedIons == 'true'
                    --multiple-charged-ions
                    --multiple-charged-ions-library '$advancedOptions.peakPatternsAnnotationCheck.multipleChargedIonsCheck.multipleChargedIonsLibrary'
                #end if
                #if $advancedOptions.peakPatternsAnnotationCheck.oligomersCheck.annotateOligomers == 'true'
                    --oligomers
                #end if
                --ion-mode '$ionMode' 
                --ppm '$massTolerance';
        #end if

        #if $advancedOptions.molecularFormulaeAnnotationCheck.annotateMolecularFormulae == 'true' 
            python -m beams annotate-mf
                --peaklist '$peakList' 
                --intensity-matrix '$intensityMatrix' 
                --db '$result_sqlite'
                #if $advancedOptions.molecularFormulaeAnnotationCheck.sourceCheck.selectedSource == 'url'
                    --db-mf 'http://multiomics-int.cs.bham.ac.uk'
                    --max-mz '$advancedOptions.molecularFormulaeAnnotationCheck.sourceCheck.maxMZ'
                #end if
                #if $advancedOptions.molecularFormulaeAnnotationCheck.sourceCheck.selectedSource == 'file'
                    --db-mf '$advancedOptions.molecularFormulaeAnnotationCheck.sourceCheck.referenceFile'
                #end if
                --adducts-library '$adductLibrary'
                --ion-mode '$ionMode' 
                --ppm '$massTolerance';
        #end if

        #if $advancedOptions.compoundsAnnotationCheck.annotateCompounds == 'true' 
            python -m beams annotate-compounds
                --peaklist '$peakList' 
                --intensity-matrix '$intensityMatrix' 
                --db '$result_sqlite'
                #if $advancedOptions.compoundsAnnotationCheck.referenceFileCheck.useReferenceFile == 'true'
                    --db-compounds '$advancedOptions.compoundsAnnotationCheck.referenceFileCheck.referenceFile'
                #end if
                #if $advancedOptions.compoundsAnnotationCheck.referenceFileCheck.useReferenceFile == 'false'
                    --db-compounds '$advancedOptions.compoundsAnnotationCheck.referenceFileCheck.referenceFile'
                #end if
                --adducts-library '$adductLibrary'
                --ion-mode '$ionMode' 
                --ppm '$massTolerance';
        #end if

        #if $advancedOptions.createSummaryCheck.createSummary == 'true' 
            python -m beams summary-results 
                --peaklist '$peakList' 
                --intensity-matrix '$intensityMatrix' 
                --db '$result_sqlite' 
                --output '$outputSummary' 
                --sep '$advancedOptions.createSummaryCheck.separator'
                #if $advancedOptions.createSummaryCheck.annotations == 'singleRowSeparateColumns' 
                    --single-column
                #end if
                #if $advancedOptions.createSummaryCheck.annotations == 'singleRowMergedColumns' 
                    --single-row
                #end if  
                #if $advancedOptions.createSummaryCheck.digitsCheck.specifyDigits == 'true' 
                    --ndigits-mz $advancedOptions.createSummaryCheck.digitsCheck.digits
                #end if  
                #if $advancedOptions.createSummaryCheck.convertRTCheck.convertRT == 'true' 
                    --convert-rt $advancedOptions.createSummaryCheck.convertRTCheck.rt
                #end if      
        #end if

    ]]></command>
    <inputs>
        <param name="peakList" value="" type="data" format="txt" label="Peaklist" help=""></param>
        <param name="intensityMatrix" value="" type="data" format="txt" label="Intensity matrix" help=""></param>
        <param name="ionMode" type="select" label="Ion mode">
            <option value="pos" selected="True">Positive</option>
            <option value="neg" selected="True">Negative</option>
        </param>
        <param name="massTolerance" value="5.0" type="float" label="Mass tolerance (PPM)" help="">
        </param>
        <param name="adductLibrary" type="data" format="txt" label="Adduct library" help=""></param>
        <section name="advancedOptions" title="Advanced options" expanded="False">
            <conditional name="groupFeaturesCheck">
                <param name="groupFeatures" type="boolean" checked="true" label="Group Features" help="" truevalue="true" falsevalue="false" />
                <when value="true">
                    <param name="maxRTDifference" value="5.0" type="float" label="Maximum RT Difference (sec)" help="">
                    </param>
                    <param name="groupingMethod" type="select" label="Grouping method">
                        <option value="pearson" selected="True">Pearson correlation</option>
                        <option value="spearman">Spearman rank correlation</option>
                    </param>
                    <param name="coefficientThreshold" value="0.7" type="text" label="Coefficient threshold" help="">
                    </param>
                    <param name="pValueThreshold" value="0.01" type="text" label="P-value threshold" help="">
                    </param>
                </when>
            </conditional>
            <conditional name="peakPatternsAnnotationCheck">
                <param name="annotatePeakPatterns" type="boolean" checked="false" label="Annotate Peak Patterns" help="" truevalue="true" falsevalue="false" />
                <when value="true">
                    <conditional name="adductsCheck">
                        <param name="useAdductsLibrary" type="boolean" checked="true" label="Adducts" help="" truevalue="true" falsevalue="false" />
                        <when value="true">
                           <param name="adductsLibrary" type="data" format="txt" label="Adducts library" help=""></param>
                        </when>
                    </conditional>
                    <conditional name="isotopesCheck">
                        <param name="useIsotopesLibrary" type="boolean" checked="true" label="Isotopes" help="" truevalue="true" falsevalue="false" />
                        <when value="true">
                           <param name="isotopesLibrary" type="data" format="txt" label="Isotopes library" help="">
                            </param>
                        </when>
                    </conditional>
                    <conditional name="multipleChargedIonsCheck">
                        <param name="useMultipleChargedIons" type="boolean" checked="true" label="Multiple charged ions" help="" truevalue="true" falsevalue="false" />
                        <when value="true">
                           <param name="multipleChargedIonsLibrary" type="data" format="txt" label="Multiple charged ions" help="">
                            </param>
                        </when>
                    </conditional>
                    <conditional name="oligomersCheck">
                        <param name="annotateOligomers" type="boolean" checked="true" label="Oligomers" help="" truevalue="true" falsevalue="false" />
                        <when value="true">
                           <param name="monomerUnits" value="3" type="integer" label="Monomer Units" help=""></param>
                        </when>
                    </conditional>
                </when>
            </conditional>
            <conditional name="molecularFormulaeAnnotationCheck">
                <param name="annotateMolecularFormulae" type="boolean" checked="false" label="Annotate Molecular Formulae" help="" truevalue="true" falsevalue="false" />
                <when value="true">
                    <conditional name="sourceCheck">
                        <param name="selectedSource" type="select" label="Source">
                            <option value="url" selected="True">http://multiomics-int.cs.bham.ac.uk</option>
                            <option value="file">Tab-delimited text file</option>
                        </param>
                        <when value="file">
                            <param name="referenceFile" type="data" format="txt" label="Reference file" help="">
                            </param>
                        </when>
                        <when value="url">
                            <param name="maxMZ" value="500" type="integer" label="Maximum m/z" help=""></param>
                            <param name="heuristicRules" type="boolean" checked="false" label="Heuristic rules" help="" truevalue="true" falsevalue="false" />
                        </when>
                    </conditional>
                </when>
            </conditional>
            <conditional name="compoundsAnnotationCheck">
                <param name="annotateCompounds" type="boolean" checked="false" label="Annotate Compounds / Metabolites" help="" truevalue="true" falsevalue="false" />
                <when value="true">
                    <conditional name="referenceFileCheck">
                        <param name="useReferenceFile" type="boolean" checked="false" label="Use reference file" help="" truevalue="true" falsevalue="false" />
                        <when value="true">
                            <param name="referenceFile" type="data" format="txt,sqlite" label="Reference File" help=""></param>
                        </when>
                        <when value="false">
                            <param name="databases" type="select" multiple="true" label="Databases">
                                <option value="groups" selected="True">groups</option>
                                <option value="adductPairs" selected="True">adduct_pairs</option>
                                <option value="isotopes" selected="True">isotopes</option>
                                <option value="peaklists" selected="True">peaklists</option>
                                <option value="peakLabels" selected="True">peak_labels</option>
                                <option value="summary" selected="True">summary</option>
                            </param>
                        </when>
                    </conditional>
                </when>
            </conditional>
            <conditional name="createSummaryCheck">
                <param name="createSummary" type="boolean" checked="false" label="Create summary" help="" truevalue="true" falsevalue="false" />
                <when value="true">
                    <param name="separator" type="select" label="Choose the delimitor">
                        <option value="tab" selected="True">Tab</option>
                        <option value="comma" selected="False">Comma</option>
                    </param>
                    <param name="annotations" type="select" label="Annotations">
                        <option value="singleRowSeparateColumns" selected="False">Single row for each feature and separate columns</option>
                        <option value="singleRowMergedColumns" selected="False">Single row for each feature and merged columns</option>
                    </param>
                    <conditional name="convertRTCheck">
                        <param name="convertRT" type="boolean" checked="true" label="Convert RT" help="" truevalue="true" falsevalue="false" />
                        <when value="true">
                            <param name="rt" type="select" label="RT">
                                <option value="min" selected="True">Minutes</option>
                                <option value="sec" selected="True">Seconds</option>
                            </param>
                        </when>
                    </conditional>
                    <conditional name="digitsCheck">
                        <param name="specifyDigits" type="boolean" checked="false" label="Number of digits" help="" truevalue="true" falsevalue="false" />
                        <when value="true">
                            <param name="digits" value="5" type="integer" label="Digits" help=""></param>
                        </when>
                    </conditional>
                </when>
            </conditional>
        </section>
    </inputs>
    <outputs>
        <data name="output_graph" format="gml" label="graph" />
        <data name="result_sqlite" format="sqlite" label="sqlite" />
        <data name="outputSummary" format="tsv" label="Summary File" />
    </outputs>
    <tests>
        <test>
            <param name="peakList" value="variableMetadata.txt"/>
            <param name="intensityMatrix" value="dataMatrix.txt"/>
            <param name="maxRetentionTimeDifference" value="5.0"/>
            <param name="groupingMethod" value="Pearson"/>
            <param name="coefficientThreshold" value="0.7"/>
            <param name="pValueThreshold" value="0.01"/>
            <param name="peakPatternsAnnotationCheck" value="true" />
            <param name="useAdductsLibrary" value="true" />
            <param name="useIsotopesLibrary" value="true" />
            <param name="adductsLibrary" value="adducts.txt" />
            <param name="isotopesLibrary" value="isotopes.txt" />
            <output name="outputSummary" file="summary.tsv" />
            <output name="output_graph" file="output_graph.gml" />
            <output name="result_sqlite" file="output_db.sqlite" />
        </test>
    </tests>
    <help>
    </help>
    <expand macro="citations" />
</tool>